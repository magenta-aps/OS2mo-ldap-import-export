# SPDX-FileCopyrightText: 2019-2020 Magenta ApS
# SPDX-License-Identifier: MPL-2.0
from unittest.mock import MagicMock
from uuid import uuid4

import pytest

from mo_ldap_import_export.autogenerated_graphql_client.client import GraphQLClient
from mo_ldap_import_export.converters import LdapConverter
from tests.graphql_mocker import GraphQLMocker


@pytest.fixture
async def converter() -> LdapConverter:
    settings = MagicMock()
    settings.org_unit_path_string_separator = "\\"

    dataloader = MagicMock()

    return LdapConverter(
        {
            "user_context": {
                "settings": settings,
                "mapping": None,
                "dataloader": dataloader,
            }
        }
    )


async def test_get_org_unit_name_for_parent(
    graphql_mock: GraphQLMocker, converter: LdapConverter
) -> None:
    graphql_client = GraphQLClient("http://example.com/graphql")
    converter.dataloader.graphql_client = graphql_client  # type: ignore

    ancestors = [
        "Plejecenter Nord",
        "Plejecentre",
        "Sundhed",
        "Kolding Kommune",
    ]

    route = graphql_mock.query("read_org_unit_ancestor_names")
    route.result = {
        "org_units": {
            "objects": [
                {
                    "current": {
                        "name": "Teknik Nord",
                        "ancestors": [{"name": name} for name in ancestors],
                    }
                }
            ]
        }
    }

    # Reversed and None added
    expected_layers = ancestors[::-1] + ["Teknik Nord", None]
    for layer, expected in enumerate(expected_layers):
        name = await converter.get_org_unit_name_for_parent(uuid4(), layer)
        assert name == expected
